{% extends 'base.html' %}
{% load static %}
{% block main %}
    <table class="display table table-borderless table-dark table-hover table-responsive table-sm table-striped" id="utility-table">
        <thead class="h6">
            <tr>
                <th title="Month">Month</th>
                <th title="Hundreds of Cubic Feet (CCF)">Hundreds of Cubic Feet (CCF)</th>
            </tr>
        </thead>
        <tbody>
            <tr id="chart-loading">
                <td colspan="2" class="text-center">
                    <div class="color-gas m-3 spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </td>
            </tr>
        </tbody>
        <tfoot class="h6">
            <tr>
                <td class="table-group-divider"><b>Total</b>:</td>
                <td class="table-group-divider" id="page-total"></td>
            </tr>
            <tr>
                <td><b>All</b>:</td>
                <td id="all-total"></td>
            </tr>
        </tfoot>
    </table>
{% endblock main %}
{% block scripts %}
    const xhr = new XMLHttpRequest()
    const naturalGasAPI = '/api/natural_gas/?format=json'
    xhr.open("GET", naturalGasAPI)
    xhr.onreadystatechange = async () => {
        if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {
            const naturalGasUsageData = JSON.parse(xhr.responseText)
            const naturalGasUsageByMonth = []
            for (const item of Object.values(naturalGasUsageData)) {
                naturalGasUsageByMonth.push([DateTime.fromISO(item.month).toMillis(), item.ccf])
            }
            const naturalGasHighChart = new Highcharts.Chart({
                title: chartTitle,
                subtitle: chartSubtitle,
                chart: chartChart,
                xAxis: { title: { text: 'Month' }, type: 'datetime' },
                yAxis: { title: { text: 'Hundreds of Cubic Feet (CCF)' }, type: 'num' },
                series: [{
                    color: '#853cfd',
                    data: naturalGasUsageByMonth,
                    name: 'Hundreds of Cubic Feet (CCF)',
                    states: { hover: { lineWidthPlus: 0 } },
                    type: 'line'
                }],
                styledMode: chartStyled,
                time: chartTime
            })

            const pageTotalNode = document.getElementById('page-total')
            const allTotalNode = document.getElementById('all-total')
            async function footerTotal (api, col=1, digits=0) {
                const pageNaturalGas = DataTable.render.number(',', '.', digits).display(api.column(col, {page: 'current'}).data().sum())
                pageTotalNode.innerHTML = `<code class="fw-bolder" title="Page Total: ${pageGas} Hundreds of Cubic Feet (CCF) (on this page)">${pageGas}</code>`
                const totalNaturalGas = DataTable.render.number(',', '.', digits).display(api.column(col).data().sum())
                allTotalNode.innerHTML = `<code class="fw-bolder" title="Total: ${totalGas} Hundreds of Cubic Feet (CCF) (all)">${totalGas}</code>`
            }
            const resultName = 'months'

            new DataTable('#utility-table', {
                data: naturalGasUsageData,
                columns: [
                    {
                        data: 'month',
                        render: DataTable.render.datetime('MMMM y'),
                    },
                    {
                        data: 'ccf',
                        render: (data, type) => {
                            if (type === 'display') {
                                let naturalGasText = 'primary'
                                if (data > 50) {
                                    naturalGasText = 'danger'
                                } else if (data > 25) {
                                    naturalGasText = 'warning'
                                } else if (data > 10) {
                                    naturalGasText = 'info'
                                }
                                return `<code class="fw-bold text-${naturalGasText}-emphasis" title="${data} Hundreds of Cubic Feet (CCF)">${data}</code>`
                            }
                            return data
                        },
                        type: 'num'
                    }
                ],
                footerCallback: async function () {
                    await footerTotal(this.api())
                },
                language: {
                    'emptyTable': `No ${resultName} available in table`,
                    'info': `Showing _START_ to _END_ of _TOTAL_ ${resultName}`,
                    'infoEmpty': `Showing 0 to 0 of 0 ${resultName}`,
                    'infoFiltered': `(filtered from _MAX_ total ${resultName})`,
                    'lengthMenu': `_MENU_ ${resultName}`,
                    'zeroRecords': `No matching ${resultName} found`
                },
                layout: chartLayout,
                lengthMenu: [
                    1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11,
                    {label: `12 *`, value: 12},
                    24, 36, 48, 60, 72, 84, 96, 108, 120, 132, 144,
                    {label: 'All', value: -1}
                ],
                order: chartOrder,
                pageLength: 12,
                stateSave: chartSave
            })
        }
    }
    xhr.send()
{% endblock scripts %}
